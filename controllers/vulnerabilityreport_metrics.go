package controllers

import (
	"github.com/prometheus/client_golang/prometheus"
	"sigs.k8s.io/controller-runtime/pkg/metrics"
)

const (
	metricNamespace = "starboard_exporter"
	metricSubsystem = "vulnerabilityreport"

	LabelGroupAll     = "all"
	labelGroupSummary = "summary"
)

type FieldScope string

const (
	FieldScopeReport        FieldScope = "report"
	FieldScopeVulnerability FieldScope = "vulnerability"
)

type valueFinder func(interface{}) string

type VulnerabilityLabel struct {
	Name    string
	Groups  []string
	Scope   FieldScope
	Handler valueFinder
}

var metricLabels = []VulnerabilityLabel{
	{
		Name:    "report_name",
		Groups:  []string{LabelGroupAll, labelGroupSummary},
		Scope:   FieldScopeReport,
		Handler: reportValueForField("Name"),
	},
	{
		Name:    "image_namespace",
		Groups:  []string{LabelGroupAll, labelGroupSummary},
		Scope:   FieldScopeReport,
		Handler: reportValueForField("Namespace"),
	},
	{
		Name:    "image_repository",
		Groups:  []string{LabelGroupAll, labelGroupSummary},
		Scope:   FieldScopeReport,
		Handler: reportValueForField("Report.Artifact.Repository"),
	},
	{
		Name:    "image_tag",
		Groups:  []string{LabelGroupAll, labelGroupSummary},
		Scope:   FieldScopeReport,
		Handler: reportValueForField("Report.Artifact.Tag"),
	},
	{
		Name:    "image_digest",
		Groups:  []string{LabelGroupAll, labelGroupSummary},
		Scope:   FieldScopeReport,
		Handler: reportValueForField("Report.Artifact.Digest"),
	},
	{
		Name: "severity",
		// Note - Summary metrics use a different severity field than per-vulnerability severity.
		Groups:  []string{LabelGroupAll, labelGroupSummary},
		Scope:   FieldScopeVulnerability,
		Handler: vulnerabilityValueForField("Severity"),
	},
	{
		Name:    "vulnerability_id",
		Groups:  []string{LabelGroupAll},
		Scope:   FieldScopeVulnerability,
		Handler: vulnerabilityValueForField("VulnerabilityID"),
	},
	{
		Name:    "vulnerable_resource_name",
		Groups:  []string{LabelGroupAll},
		Scope:   FieldScopeVulnerability,
		Handler: vulnerabilityValueForField("Resource"),
	},
	{
		Name:    "installed_resource_version",
		Groups:  []string{LabelGroupAll},
		Scope:   FieldScopeVulnerability,
		Handler: vulnerabilityValueForField("InstalledVersion"),
	},
	{
		Name:    "fixed_resource_version",
		Groups:  []string{LabelGroupAll},
		Scope:   FieldScopeVulnerability,
		Handler: vulnerabilityValueForField("FixedVersion"),
	},
	{
		Name:    "vulnerability_title",
		Groups:  []string{LabelGroupAll},
		Scope:   FieldScopeVulnerability,
		Handler: vulnerabilityValueForField("Title"),
	},
	{
		Name:    "vulnerability_link",
		Groups:  []string{LabelGroupAll},
		Scope:   FieldScopeVulnerability,
		Handler: vulnerabilityValueForField("PrimaryLink"),
	},
}

func LabelWithName(name string) (label VulnerabilityLabel, ok bool) {
	for _, label := range metricLabels {
		if label.Name == name {
			return label, true
		}
	}
	return VulnerabilityLabel{}, false
}

func sliceContains(s []string, value string) bool {
	for _, item := range s {
		if item == value {
			return true
		}
	}
	return false
}

func LabelsForGroup(group string) []VulnerabilityLabel {
	l := []VulnerabilityLabel{}
	for _, label := range metricLabels {
		if sliceContains(label.Groups, group) {
			l = append(l, label)
		}
	}
	return l
}

func labelNamesForGroup(group string) []string {
	l := []string{}
	for _, label := range metricLabels {
		if sliceContains(label.Groups, group) {
			l = append(l, label.Name)
		}
	}
	return l
}

func LabelNamesForList(list []VulnerabilityLabel) []string {
	l := []string{}
	for _, label := range list {
		l = append(l, label.Name)
	}
	return l
}

// Gauge for the count of all vulnerabilities of a particular severity contained in an image.
var (
	VulnerabilitySummary = prometheus.NewGaugeVec(
		prometheus.GaugeOpts{
			Namespace: metricNamespace,
			Subsystem: metricSubsystem,
			Name:      "image_vulnerability_severity_count",
			Help:      "Exposes the number of vulnerabilities of a particular severity per-image.",
		},
		labelNamesForGroup(labelGroupSummary),
	)
)

// Gauge reporting the score of each CVE present in an image.
// Registered during first reconcile loop in registerMetrics().
var VulnerabilityInfo *prometheus.GaugeVec

func init() {
	// Register custom metrics with the global prometheus registry
	metrics.Registry.MustRegister(VulnerabilitySummary) // VulnerabilityInfo
}
